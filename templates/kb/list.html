{% extends "base.html" %}
{% block content %}
  <style>
    .kb-header { display:flex; flex-direction:column; gap:1rem; margin-bottom:1.5rem; }
    .kb-search { display:flex; gap:.4rem; flex-wrap:wrap; }
    .kb-search input { flex:1 1 240px; padding:.5rem .7rem; border:1px solid #ccc; border-radius:6px; }
    .kb-search button { padding:.5rem 1rem; border:1px solid #333; border-radius:6px; background:#333; color:#fff; cursor:pointer; }
    .kb-search button:hover { background:#000; }

    .kb-grid { display:grid; gap:1rem; grid-template-columns:repeat(auto-fit, minmax(260px, 1fr)); }
    .kb-card { border:1px solid #e5e7eb; border-radius:12px; padding:1rem 1.2rem; box-shadow:0 6px 18px rgba(15,23,42,.05); transition:transform .15s ease, box-shadow .15s ease; background:#fff; }
    .kb-card:hover { transform:translateY(-2px); box-shadow:0 10px 24px rgba(15,23,42,.12); }

    .kb-card h3 { margin:.2rem 0; font-size:1.15rem; }
    .kb-card h3 a { text-decoration:none; color:#1d4ed8; }
    .kb-card h3 a:hover { text-decoration:underline; }

    .kb-meta { margin-top:.6rem; display:flex; flex-direction:column; gap:.35rem; font-size:.85rem; color:#6b7280; }
    .kb-tag { align-self:flex-start; background:#e0ecff; color:#1d4ed8; border:1px solid #bcd4ff; padding:.3rem .75rem; border-radius:999px; font-weight:600; letter-spacing:.01em; }

    .kb-empty { padding:1.5rem; border:1px dashed #cbd5f5; border-radius:12px; text-align:center; color:#6b7280; }
    @media (max-width:640px) { .kb-header { gap:.7rem; } }
  </style>

  <section class="kb-header">
    <h2 style="margin:0;">Knowledge Base</h2>
    <form method="get" class="kb-search" id="kb-search-form">
      <input type="text" id="kb-search-input" name="q" value="{{ q }}" placeholder="Search articles...">
      <button type="submit" id="kb-search-submit">Search</button>
    </form>
  </section>

  {% if articles %}
    <div class="kb-grid" id="kb-grid">
      {% for a in articles %}
        <article class="kb-card" data-kb-card data-search="{{ a.title|lower }} {% if a.category %}{{ a.category.name|lower }}{% endif %} {{ a.content|striptags|lower }}">
          <h3><a href="{% url 'kb_detail' a.slug %}">{{ a.title }}</a></h3>
          <div class="kb-meta">
            {% if a.category and a.category.name|lower != a.title|lower %}
              <span class="kb-tag">{{ a.category.name }}</span>
            {% endif %}
            <span>Views: {{ a.views }}</span>
            <span>Updated: {{ a.updated_at|date:"Y-m-d H:i" }}</span>
          </div>
        </article>
      {% endfor %}
    </div>
    <div id="kb-no-results" class="kb-empty" style="display:none;">No articles match your search.</div>
  {% else %}
    <div class="kb-empty">No articles found. Try a different search or check back later.</div>
  {% endif %}

  <script>
    (function() {
      const form = document.getElementById('kb-search-form');
      const input = document.getElementById('kb-search-input');
      const cards = Array.from(document.querySelectorAll('[data-kb-card]'));
      const noResults = document.getElementById('kb-no-results');

      if (!form || !input || cards.length === 0) {
        return;
      }

      const filterCards = () => {
        const query = input.value.trim().toLowerCase();
        let visibleCount = 0;

        cards.forEach(card => {
          const haystack = card.dataset.search || '';
          const matches = query === '' || haystack.includes(query);
          card.style.display = matches ? '' : 'none';
          if (matches) {
            visibleCount += 1;
          }
        });

        if (noResults) {
          noResults.style.display = visibleCount === 0 ? '' : 'none';
        }
      };

      form.addEventListener('submit', event => {
        event.preventDefault();
        filterCards();
      });

      input.addEventListener('input', filterCards);

      // Run once on load to honor any pre-filled query param.
      filterCards();
    })();
  </script>
{% endblock %}
