{% extends 'base.html' %}
{% block content %}
  <style>
    .ticket-shell { display:grid; gap:1.6rem; grid-template-columns:1fr; }
    .ticket-layout { display:grid; gap:1.5rem; grid-template-columns: minmax(0, 2fr) minmax(0, 1fr); }
    .pane-card { background:#fff; border:1px solid #e5e7eb; border-radius:18px; box-shadow:0 18px 36px rgba(15,23,42,.07); }
    .pane-body { padding:1.6rem; display:flex; flex-direction:column; gap:1.25rem; }
    .ticket-header { display:flex; justify-content:space-between; gap:1rem; align-items:center; }
    .ticket-title { margin:0; font-size:1.6rem; color:#0f172a; }
    .status-pill { display:inline-flex; align-items:center; gap:.35rem; padding:.3rem .75rem; border-radius:999px; font-size:.82rem; font-weight:600; text-transform:capitalize; }
    .priority-pill { display:inline-flex; align-items:center; gap:.35rem; padding:.3rem .75rem; border-radius:999px; font-size:.82rem; font-weight:600; text-transform:capitalize; }
    .status-new { background:#e0f2ff; color:#1d4ed8; }
    .status-in_progress { background:#ede9fe; color:#5b21b6; }
    .status-waiting { background:#fef9c3; color:#92400e; }
    .status-resolved { background:#dcfce7; color:#166534; }
    .status-escalated { background:#fee2e2; color:#b91c1c; }
    .priority-low { background:#e2f5ff; color:#0369a1; }
    .priority-medium { background:#fff4d7; color:#b45309; }
    .priority-high { background:#fee4e2; color:#b91c1c; }
    .priority-urgent { background:#fee2f2; color:#be185d; }
    .meta-grid { display:grid; gap:1rem; grid-template-columns:repeat(auto-fit, minmax(160px, 1fr)); }
    .meta-item { background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; padding:1rem; }
    .meta-label { display:block; font-size:.75rem; text-transform:uppercase; letter-spacing:.05em; color:#64748b; margin-bottom:.35rem; }
    .meta-value { font-weight:600; color:#0f172a; }
    .description { white-space:pre-line; color:#1f2937; line-height:1.55; }
    .comments-card { background:#fff; border:1px solid #e5e7eb; border-radius:18px; box-shadow:0 12px 28px rgba(15,23,42,.05); }
    .comments-header { padding:1.2rem 1.6rem; border-bottom:1px solid #e5e7eb; font-weight:600; color:#0f172a; }
    .comment-list { list-style:none; margin:0; padding:0; }
    .comment-item { padding:1.2rem 1.6rem; border-bottom:1px solid #e5e7eb; display:flex; flex-direction:column; gap:.4rem; }
    .comment-item:last-child { border-bottom:none; }
    .comment-meta { display:flex; justify-content:space-between; align-items:center; font-size:.85rem; color:#64748b; }
    .comment-body { color:#1e293b; line-height:1.5; white-space:pre-line; }
    .sidebar-card { background:#0f172a; color:#fff; border-radius:18px; box-shadow:0 18px 40px rgba(15,23,42,.3); padding:1.6rem; display:flex; flex-direction:column; gap:1rem; }
    .sidebar-card h3 { margin:0; font-size:1.1rem; }
    .sidebar-actions { display:grid; gap:.75rem; }
    .sidebar-actions a { display:inline-flex; align-items:center; justify-content:center; gap:.4rem; padding:.65rem 1.1rem; border-radius:999px; font-weight:600; text-decoration:none; color:#0f172a; background:#fff; box-shadow:0 10px 24px rgba(255,255,255,.25); transition:transform .15s ease, box-shadow .15s ease; }
    .sidebar-actions a:hover { transform:translateY(-2px); }
    .pane-body textarea { border:1px solid #dbe2ef; border-radius:12px; padding:.75rem 1rem; font:inherit; min-height:6rem; }
    .pane-body input[type="checkbox"] { width:1rem; height:1rem; }
    .back-link { text-decoration:none; color:#1d4ed8; font-weight:600; }
    .back-link:hover { text-decoration:underline; }
    @media (max-width:960px) {
      .ticket-layout { grid-template-columns:1fr; }
    }
  </style>

  <div class="ticket-shell">
    <a class="back-link" href="{% url 'ticket_list' %}">← Back to tickets</a>

    <div class="ticket-layout">
      <section class="pane-card">
        <div class="pane-body">
          <div class="ticket-header">
            <h1 class="ticket-title">{{ ticket.title }}</h1>
            <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
              <span class="priority-pill priority-{{ ticket.priority }}">{{ ticket.get_priority_display }}</span>
              <span class="status-pill status-{{ ticket.status }}">{{ ticket.get_status_display }}</span>
            </div>
          </div>

          <div class="description">{{ ticket.description }}</div>

          <div class="meta-grid">
            <div class="meta-item">
              <span class="meta-label">Ticket ID</span>
              <span class="meta-value">#{{ ticket.id }}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Requester</span>
              <span class="meta-value">{{ ticket.requester_email|default:"—" }}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Created</span>
              <span class="meta-value">{{ ticket.created_at|date:"Y-m-d H:i" }}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Updated</span>
              <span class="meta-value">{{ ticket.updated_at|date:"Y-m-d H:i" }}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Assigned To</span>
              <span class="meta-value">
                {% if ticket.assigned_to %}
                  {{ ticket.assigned_to.get_full_name|default:ticket.assigned_to.username }}
                {% else %}
                  Unassigned
                {% endif %}
              </span>
            </div>
            <div class="meta-item">
              <span class="meta-label">SLA Due</span>
              <span class="meta-value">
                {% if ticket.sla_due %}
                  {{ ticket.sla_due|date:"Y-m-d H:i" }}
                {% else %}
                  —
                {% endif %}
              </span>
            </div>
          </div>
        </div>
      </section>

      <aside class="sidebar-card">
        <div>
          <h3>Quick actions</h3>
          <p style="margin:0; font-size:.92rem; opacity:.85;">Update the ticket state or add more detail to keep stakeholders informed.</p>
        </div>
        <div class="sidebar-actions">
          <a href="{% url 'ticket_edit' ticket.id %}">✎ Edit ticket</a>
          <a href="{% url 'ticket_edit' ticket.id %}?set=resolved" style="background:#dcfce7; color:#166534;">✔ Mark resolved</a>
          <a href="{% url 'ticket_edit' ticket.id %}?set=escalated" style="background:#fee2e2; color:#b91c1c;">⚠ Escalate</a>
        </div>
      </aside>
    </div>

    <section class="comments-card">
      <div class="comments-header">Discussion</div>
      <ul class="comment-list">
        {% if comments %}
          {% for c in comments %}
            <li class="comment-item">
              <div class="comment-meta">
                <span>
                  {% if c.author %}
                    {{ c.author.get_full_name|default:c.author.username }}
                  {% else %}
                    Anonymous
                  {% endif %}
                </span>
                <span>{{ c.created_at|date:"Y-m-d H:i" }}</span>
              </div>
              <div class="comment-body">{{ c.body|linebreaksbr }}</div>
            </li>
          {% endfor %}
        {% else %}
          <li class="comment-item">
            <div class="comment-body" style="color:#64748b;">No comments yet. Use the form below to leave an update for the team.</div>
          </li>
        {% endif %}
      </ul>
    </section>

    {% if comment_form %}
      <section class="pane-card">
        <div class="pane-body">
          <h2 style="margin:0; font-size:1.2rem; color:#0f172a;">Add a comment</h2>
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="add_comment" value="1">
            <div style="display:flex; flex-direction:column; gap:.9rem;">
              <label style="display:flex; flex-direction:column; gap:.35rem; font-weight:600; color:#0f172a;">
                Message
                {{ comment_form.body }}
              </label>
              <label style="display:flex; align-items:center; gap:.5rem; font-size:.9rem; color:#475569;">
                {{ comment_form.is_internal }}
                Internal note (only staff can see this)
              </label>
            </div>
            <div style="margin-top:1rem;">
              <button type="submit" style="background:#1d4ed8; color:#fff; border:none; border-radius:999px; padding:.65rem 1.4rem; font-weight:600; cursor:pointer;">Post comment</button>
            </div>
          </form>
        </div>
      </section>
    {% endif %}
  </div>
{% endblock %}
