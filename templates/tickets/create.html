{% extends "base.html" %}
{% block content %}
  <style>
    .form-shell { display:flex; flex-direction:column; gap:1.8rem; }
    .form-hero { background:linear-gradient(135deg, #1d4ed8, #2563eb); color:#fff; padding:1.8rem; border-radius:20px; box-shadow:0 20px 45px rgba(29,78,216,.25); display:flex; flex-direction:column; gap:1rem; }
    .form-hero h1 { margin:0; font-size:1.8rem; }
    .form-hero p { margin:0; max-width:640px; opacity:.9; }
    .form-card { background:#fff; border:1px solid #e5e7eb; border-radius:20px; box-shadow:0 16px 40px rgba(15,23,42,.08); padding:1.8rem; display:flex; flex-direction:column; gap:1.4rem; }
    .form-grid { display:grid; gap:1.2rem; }
    .form-field { display:flex; flex-direction:column; gap:.45rem; }
    .form-field label { font-weight:600; color:#0f172a; }
    .form-field input,
    .form-field select,
    .form-field textarea { border:1px solid #dbe2ef; border-radius:12px; padding:.75rem 1rem; font:inherit; }
    .form-footer { display:flex; flex-wrap:wrap; gap:.8rem; justify-content:flex-end; }
    .btn-primary { background:#1d4ed8; color:#fff; border:none; border-radius:999px; padding:.75rem 1.6rem; font-weight:600; cursor:pointer; }
    .btn-secondary { background:#f1f5f9; color:#0f172a; border:none; border-radius:999px; padding:.75rem 1.6rem; font-weight:600; text-decoration:none; display:inline-flex; align-items:center; }
    .suggest-card { background:#f8fafc; border:1px solid #e2e8f0; border-radius:16px; padding:1.1rem; display:none; }
    .suggest-card strong { display:block; margin-bottom:.5rem; }
    .suggest-list { list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:.35rem; }
    .suggest-list a { color:#1d4ed8; text-decoration:none; }
    .suggest-list a:hover { text-decoration:underline; }
    @media (max-width:640px) {
      .form-card { padding:1.4rem; }
      .form-footer { justify-content:stretch; }
      .btn-primary, .btn-secondary { width:100%; justify-content:center; }
    }
  </style>

  <div class="form-shell">
    <section class="form-hero">
      <div>
        <h1>Submit a support ticket</h1>
        <p>Provide details about the issue so the support team can troubleshoot quickly. Youâ€™ll be notified as the ticket progresses.</p>
      </div>
    </section>

    <section class="form-card">
      <form method="post" id="ticket-form">
        {% csrf_token %}
        <div class="form-grid">
          <div class="form-field">
            <label for="id_title">Title</label>
            {{ form.title }}
          </div>

          <div class="suggest-card" id="kb-suggestions">
            <strong>Suggested knowledge base articles</strong>
            <ul class="suggest-list" id="kb-list"></ul>
          </div>

          <div class="form-field">
            <label for="id_description">Description</label>
            {{ form.description }}
          </div>

          <div class="form-field">
            <label for="id_priority">Priority</label>
            {{ form.priority }}
          </div>

          <div class="form-field">
            <label for="id_requester_email">Requester email (optional)</label>
            {{ form.requester_email }}
          </div>
        </div>

        <div class="form-footer">
          <a class="btn-secondary" href="{% url 'ticket_list' %}">Cancel</a>
          <button class="btn-primary" type="submit">Submit ticket</button>
        </div>
      </form>
    </section>
  </div>

  <script>
    (function() {
      const titleInput = document.getElementById("id_title");
      const kbBox = document.getElementById("kb-suggestions");
      const kbList = document.getElementById("kb-list");

      if (!titleInput || !kbBox || !kbList) {
        return;
      }

      let timeout = null;

      const fetchSuggestions = () => {
        const query = titleInput.value.trim();
        if (query.length < 3) {
          kbBox.style.display = "none";
          kbList.innerHTML = "";
          return;
        }

        timeout = setTimeout(() => {
          fetch(`/tickets/new/?q=${encodeURIComponent(query)}`, {
            headers: { "X-Requested-With": "XMLHttpRequest" }
          })
            .then(response => response.json())
            .then(data => {
              kbList.innerHTML = "";
              if (data.results && data.results.length > 0) {
                kbBox.style.display = "block";
                data.results.forEach(article => {
                  const li = document.createElement("li");
                  const link = document.createElement("a");
                  link.href = `/kb/${article.slug}/`;
                  link.target = "_blank";
                  link.textContent = article.title;
                  li.appendChild(link);
                  kbList.appendChild(li);
                });
              } else {
                kbBox.style.display = "none";
              }
            })
            .catch(() => {
              kbBox.style.display = "none";
            });
        }, 350);
      };

      titleInput.addEventListener("input", () => {
        clearTimeout(timeout);
        fetchSuggestions();
      });
    })();
  </script>
{% endblock %}
